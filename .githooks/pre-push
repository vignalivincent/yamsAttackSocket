#!/bin/bash

# Check branch naming convention for the current branch
BRANCH=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')
BRANCH_REGEX='^(feature|bugfix|hotfix|release|docs|refactor|test|infra|config|scripts|docker|cicd)/[a-z0-9-]+$'

if ! [[ "$BRANCH" =~ $BRANCH_REGEX ]]; then
  echo "Branch naming does not follow convention: $BRANCH"
  echo "Branch names should follow the pattern: <type>/<description>"
  echo "Where <type> is one of: feature, bugfix, hotfix, release, docs, refactor, test, infra, config, scripts, docker, cicd"
  echo "And <description> is lowercase with hyphens (e.g., user-authentication)"
  echo "Example: feature/user-authentication"
  exit 1
fi

# Prevent pushing to master branch
while read local_ref local_sha remote_ref remote_sha
do
  if [[ "$remote_ref" == "refs/heads/master" ]]; then
    echo "Direct push to master branch is not allowed."
    echo "Please create a pull request instead."
    exit 1
  fi
done

echo "Running tests before push..."
make test

if [ $? -ne 0 ]; then
  echo "Tests failed! Push aborted."
  exit 1
fi

exit 0
